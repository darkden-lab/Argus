apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: {{ include "k8s-dashboard.fullname" . }}
  labels:
    {{- include "k8s-dashboard.labels" . | nindent 4 }}
rules:
  # Core resources
  - apiGroups: [""]
    resources:
      - pods
      - pods/log
      - pods/exec
      - services
      - endpoints
      - configmaps
      - secrets
      - namespaces
      - nodes
      - persistentvolumeclaims
      - persistentvolumes
      - events
      - serviceaccounts
      - replicationcontrollers
      - resourcequotas
      - limitranges
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  # Apps resources
  - apiGroups: ["apps"]
    resources:
      - deployments
      - daemonsets
      - replicasets
      - statefulsets
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  # Batch resources
  - apiGroups: ["batch"]
    resources:
      - jobs
      - cronjobs
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  # Networking resources
  - apiGroups: ["networking.k8s.io"]
    resources:
      - ingresses
      - networkpolicies
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  # RBAC resources
  - apiGroups: ["rbac.authorization.k8s.io"]
    resources:
      - roles
      - rolebindings
      - clusterroles
      - clusterrolebindings
    verbs: ["get", "list", "watch"]
  # Storage resources
  - apiGroups: ["storage.k8s.io"]
    resources:
      - storageclasses
    verbs: ["get", "list", "watch"]
  # Autoscaling resources
  - apiGroups: ["autoscaling"]
    resources:
      - horizontalpodautoscalers
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  # Metrics
  - apiGroups: ["metrics.k8s.io"]
    resources:
      - pods
      - nodes
    verbs: ["get", "list"]
  # Custom Resource Definitions (read access for all)
  - apiGroups: ["apiextensions.k8s.io"]
    resources:
      - customresourcedefinitions
    verbs: ["get", "list", "watch"]

  # --- Plugin CRDs ---

  # Istio networking and security
  {{- if .Values.plugins.istio.enabled }}
  - apiGroups: ["networking.istio.io"]
    resources: ["*"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  - apiGroups: ["security.istio.io"]
    resources: ["*"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  {{- end }}

  # Prometheus Operator (ServiceMonitors, PrometheusRules, etc.)
  {{- if .Values.plugins.prometheus.enabled }}
  - apiGroups: ["monitoring.coreos.com"]
    resources: ["*"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  {{- end }}

  # Calico network policies and IP pools
  {{- if .Values.plugins.calico.enabled }}
  - apiGroups: ["crd.projectcalico.org"]
    resources: ["*"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  {{- end }}

  # CloudNativePG (Clusters, Backups, ScheduledBackups, Poolers)
  {{- if .Values.plugins.cnpg.enabled }}
  - apiGroups: ["postgresql.cnpg.io"]
    resources:
      - clusters
      - backups
      - scheduledbackups
      - poolers
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  {{- end }}

  # MariaDB Operator (MariaDB instances, Databases, Backups)
  {{- if .Values.plugins.mariadb.enabled }}
  - apiGroups: ["k8s.mariadb.com"]
    resources:
      - mariadbs
      - databases
      - backups
      - restores
      - users
      - grants
      - connections
      - sqljobs
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  {{- end }}

  # KEDA (ScaledObjects, ScaledJobs, TriggerAuthentications)
  {{- if .Values.plugins.keda.enabled }}
  - apiGroups: ["keda.sh"]
    resources:
      - scaledobjects
      - scaledjobs
      - triggerauthentications
      - clustertriggerauthentications
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  {{- end }}

  # Rook Ceph (CephClusters, CephBlockPools, CephFilesystems)
  {{- if .Values.plugins.ceph.enabled }}
  - apiGroups: ["ceph.rook.io"]
    resources:
      - cephclusters
      - cephblockpools
      - cephfilesystems
      - cephobjectstores
      - cephobjectstoreusers
      - cephnfses
      - cephclients
      - cephrbdmirrors
      - cephfilesystemmirrors
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  {{- end }}

  # Flux HelmRelease management (helm.toolkit.fluxcd.io)
  {{- if .Values.plugins.helm.enabled }}
  - apiGroups: ["helm.toolkit.fluxcd.io"]
    resources:
      - helmreleases
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  - apiGroups: ["source.toolkit.fluxcd.io"]
    resources:
      - helmrepositories
      - helmcharts
      - gitrepositories
      - ocirepositories
    verbs: ["get", "list", "watch"]
  {{- end }}
