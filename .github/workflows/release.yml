name: Release

on:
  push:
    tags:
      - "release-*"
      - "v*"

env:
  REGISTRY: ghcr.io
  GO_VERSION: "1.25"

permissions:
  contents: write
  packages: write

jobs:
  # ---------------------------------------------------------------------------
  # 1. Extract version from the tag once; every other job references it.
  # ---------------------------------------------------------------------------
  prepare:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.VERSION }}
    steps:
      - name: Extract version from tag
        id: version
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          # Strip "release-" or "v" prefix
          VERSION="${TAG#release-}"
          VERSION="${VERSION#v}"
          echo "VERSION=$VERSION" >> "$GITHUB_OUTPUT"

  # ---------------------------------------------------------------------------
  # 2. Build & push Docker images (backend, frontend, agent)
  # ---------------------------------------------------------------------------
  docker-images:
    runs-on: ubuntu-latest
    needs: prepare
    env:
      VERSION: ${{ needs.prepare.outputs.version }}
    strategy:
      matrix:
        include:
          - image: ghcr.io/darkden-lab/argus-backend
            context: ./backend
            file: deploy/docker/Dockerfile.backend
          - image: ghcr.io/darkden-lab/argus-frontend
            context: ./frontend
            file: deploy/docker/Dockerfile.frontend
          - image: ghcr.io/darkden-lab/argus-agent
            context: .
            file: deploy/docker/Dockerfile.agent
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set up QEMU (multi-platform builds)
        uses: docker/setup-qemu-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push image
        uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.file }}
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ${{ matrix.image }}:${{ env.VERSION }}
            ${{ matrix.image }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ---------------------------------------------------------------------------
  # 3. Build CLI binaries (Go cross-compile)
  # ---------------------------------------------------------------------------
  cli-binaries:
    runs-on: ubuntu-latest
    needs: prepare
    env:
      VERSION: ${{ needs.prepare.outputs.version }}
    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
            binary: argus-linux-amd64
          - goos: linux
            goarch: arm64
            binary: argus-linux-arm64
          - goos: darwin
            goarch: amd64
            binary: argus-darwin-amd64
          - goos: darwin
            goarch: arm64
            binary: argus-darwin-arm64
          - goos: windows
            goarch: amd64
            binary: argus-windows-amd64.exe
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: cli/go.sum

      - name: Build CLI binary
        working-directory: cli
        env:
          CGO_ENABLED: "0"
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
        run: |
          go build -trimpath \
            -ldflags="-s -w -X main.version=${{ env.VERSION }}" \
            -o "${{ matrix.binary }}" \
            ./cmd/argus/

      - name: Upload CLI binary
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.binary }}
          path: cli/${{ matrix.binary }}
          if-no-files-found: error

  # ---------------------------------------------------------------------------
  # 4. Build agent binaries (Go cross-compile)
  # ---------------------------------------------------------------------------
  agent-binaries:
    runs-on: ubuntu-latest
    needs: prepare
    env:
      VERSION: ${{ needs.prepare.outputs.version }}
    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
            binary: argus-agent-linux-amd64
          - goos: linux
            goarch: arm64
            binary: argus-agent-linux-arm64
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: agent/go.sum

      - name: Build agent binary
        working-directory: agent
        env:
          CGO_ENABLED: "0"
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
        run: |
          go build -trimpath \
            -ldflags="-s -w -X main.version=${{ env.VERSION }}" \
            -o "${{ matrix.binary }}" \
            ./cmd/agent/

      - name: Upload agent binary
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.binary }}
          path: agent/${{ matrix.binary }}
          if-no-files-found: error

  # ---------------------------------------------------------------------------
  # 5. Build Linux packages (deb/rpm) using nfpm
  # ---------------------------------------------------------------------------
  linux-packages:
    runs-on: ubuntu-latest
    needs: [prepare, cli-binaries]
    env:
      VERSION: ${{ needs.prepare.outputs.version }}
    strategy:
      matrix:
        arch: [amd64, arm64]
        format: [deb, rpm]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: argus-linux-${{ matrix.arch }}
          path: packaging/dist/

      - name: Rename binary for nfpm
        run: |
          mv packaging/dist/argus-linux-${{ matrix.arch }} \
             packaging/dist/argus_linux_${{ matrix.arch }}

      - name: Build ${{ matrix.format }} package (${{ matrix.arch }})
        uses: goreleaser/nfpm-action@v0.4.0
        env:
          VERSION: ${{ env.VERSION }}
          ARCH: ${{ matrix.arch }}
        with:
          nfpm: packaging/nfpm.yaml
          packager: ${{ matrix.format }}
          target: packaging/dist/

      - uses: actions/upload-artifact@v4
        with:
          name: argus-${{ matrix.format }}-${{ matrix.arch }}
          path: packaging/dist/*.${{ matrix.format }}

  # ---------------------------------------------------------------------------
  # 6. Package Helm charts
  # ---------------------------------------------------------------------------
  helm-charts:
    runs-on: ubuntu-latest
    needs: prepare
    env:
      VERSION: ${{ needs.prepare.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Package Helm charts
        run: |
          helm package deploy/helm/argus \
            --version "$VERSION" \
            --app-version "$VERSION" \
            --destination ./helm-out
          helm package deploy/helm/argus-agent \
            --version "$VERSION" \
            --app-version "$VERSION" \
            --destination ./helm-out

      - name: Upload Helm chart artifacts
        uses: actions/upload-artifact@v4
        with:
          name: helm-charts
          path: helm-out/*.tgz
          if-no-files-found: error

  # ---------------------------------------------------------------------------
  # 7. Create GitHub Release with all assets
  # ---------------------------------------------------------------------------
  github-release:
    runs-on: ubuntu-latest
    needs:
      - prepare
      - docker-images
      - cli-binaries
      - agent-binaries
      - linux-packages
      - helm-charts
    env:
      VERSION: ${{ needs.prepare.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-assets
          merge-multiple: true

      - name: List release assets
        run: ls -lhR release-assets/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Argus v${{ env.VERSION }}
          generate_release_notes: true
          files: release-assets/*
